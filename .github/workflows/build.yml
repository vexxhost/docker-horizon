name: build

on:
  pull_request:
  workflow_dispatch:
  push:
    branches:
      - main
      - stable/**

jobs:
  image:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      packages: write
      pull-requests: write
    steps:
      - uses: vexxhost/docker-atmosphere/.github/actions/checkout@main
        with:
          repository: openstack/horizon
          ref: fdaaf6e1a1708deeb6b7a24ab0961e2480337e1c # stable/2024.2

      - uses: vexxhost/docker-atmosphere/.github/actions/checkout@main
        with:
          repository: openstack/designate-dashboard
          ref: e7f1583643792b858142bcd4a7d99950646e6ffd # stable/2024.2

      - uses: vexxhost/docker-atmosphere/.github/actions/checkout@main
        with:
          repository: openstack/heat-dashboard
          ref: f6dc92a972c36f9e8258a16ec0891845ef8accca # stable/2024.2

      - uses: vexxhost/docker-atmosphere/.github/actions/checkout@main
        with:
          repository: openstack/ironic-ui
          ref: 40d8f907334c113cf2fe43bd2a5bbbef6baadbab # stable/2024.2

      - uses: vexxhost/docker-atmosphere/.github/actions/checkout@main
        with:
          repository: openstack/magnum-ui
          ref: c9fdb537eaded73e81ea296d893e45d753337dc7 # stable/2024.2

      - uses: vexxhost/docker-atmosphere/.github/actions/checkout@main
        with:
          repository: openstack/manila-ui
          ref: 55945d56a479790e5443299fa4991e7728a6f89d # stable/2024.2

      - uses: vexxhost/docker-atmosphere/.github/actions/checkout@main
        with:
          repository: openstack/neutron-vpnaas-dashboard
          ref: 6207d9a20b2f3c53a50d767a364aa8c448a2c923 # stable/2024.2

      - uses: vexxhost/docker-atmosphere/.github/actions/checkout@main
        with:
          repository: openstack/octavia-dashboard
          ref: 1d4b034669c819217a0f58a394dae4340661bdeb # stable/2024.2

      - uses: vexxhost/docker-atmosphere/.github/actions/build-image@main
        with:
          image-name: horizon
          build-contexts: |
            horizon=openstack/horizon
            designate-dashboard=openstack/designate-dashboard
            heat-dashboard=openstack/heat-dashboard
            ironic-ui=openstack/ironic-ui
            magnum-ui=openstack/magnum-ui
            manila-ui=openstack/manila-ui
            neutron-vpnaas-dashboard=openstack/neutron-vpnaas-dashboard
            octavia-dashboard=openstack/octavia-dashboard
          push: ${{ github.event_name != 'pull_request' }}

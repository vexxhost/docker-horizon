From c2d951d7d557e07b725a7400f9bdb36bc229d262 Mon Sep 17 00:00:00 2001
From: Dong Ma <winterma.dong@gmail.com>
Date: Wed, 4 Feb 2026 13:42:35 +0800
Subject: [PATCH] fix(api): Avoid RecursionError when deepcopy Port apidict

When the apidict passed to Port.__init__ is an openstacksdk Resource
object, calling copy.deepcopy() on it can trigger a RecursionError.
This happens because openstacksdk CloudRegion.__getattr__ method
can cause infinite recursion during deepcopy operations.

This fix converts the apidict to a plain dict using to_dict() before
deepcopy if the method is available, avoiding the recursion issue.

Change-Id: Ia0de61ae6461c06158b285923d1abab373b4b792
Signed-off-by: Dong Ma <winterma.dong@gmail.com>
---
 openstack_dashboard/api/neutron.py | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

diff --git a/openstack_dashboard/api/neutron.py b/openstack_dashboard/api/neutron.py
index bce0c20d3..423f3ac18 100644
--- a/openstack_dashboard/api/neutron.py
+++ b/openstack_dashboard/api/neutron.py
@@ -203,7 +203,13 @@ class Port(NeutronAPIDictWrapper):
                 ON_STATE if apidict['mac_learning_enabled'] else OFF_STATE
         pairs = apidict.get('allowed_address_pairs')
         if pairs:
-            apidict = copy.deepcopy(apidict)
+            # Convert to dict first if possible to avoid RecursionError
+            # when deepcopy encounters openstacksdk objects with custom
+            # __getattr__ methods. to_dict() already returns a new dict.
+            if hasattr(apidict, 'to_dict'):
+                apidict = apidict.to_dict()
+            else:
+                apidict = copy.deepcopy(apidict)
             wrapped_pairs = [PortAllowedAddressPair(pair) for pair in pairs]
             apidict['allowed_address_pairs'] = wrapped_pairs
         super().__init__(apidict)
-- 
2.25.1

